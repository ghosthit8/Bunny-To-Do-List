<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bunny To-Do List ‚ô•</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

  <style>
    :root{
      --bgTop:#effcff;
      --bgMid:#efe6ff;
      --bgBot:#e6fff3;

      --panel:rgba(255,255,255,.62);
      --fg:#3b2a3a;

      --neon:#39ff88;
      --pink:#ff6fa9;

      --lav:#a78bfa;
      --mint:#7cf0c3;

      --shadow: rgba(40,20,50,.20);
      --pixel: 2px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      color:var(--fg);
      font-family:"VT323", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:20px;

      background:
        radial-gradient(1100px 800px at 18% 18%, rgba(167,139,250,.30), transparent 55%),
        radial-gradient(900px 700px at 85% 55%, rgba(124,240,195,.28), transparent 58%),
        radial-gradient(900px 700px at 55% 0%, rgba(255,111,169,.16), transparent 55%),
        linear-gradient(180deg, var(--bgTop), var(--bgMid) 55%, var(--bgBot));
      min-height:100vh;
      overflow-x:hidden;
      position:relative;
    }

    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      mix-blend-mode:soft-light;
      opacity:.35;
      z-index:1;
    }

    body::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background: repeating-linear-gradient(
        to bottom,
        rgba(40,20,50,.04) 0px,
        rgba(40,20,50,.04) 1px,
        rgba(0,0,0,0) 2px,
        rgba(0,0,0,0) 6px
      );
      opacity:.12;
      z-index:2;
    }

    /* ‚ú® Pixel stars ‚Äî BIG + BRIGHT + EVERYWHERE */
    .pixelStars{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:9999;
      isolation:isolate;
      overflow:hidden;
      opacity:.95;
      mix-blend-mode: screen;
      filter: drop-shadow(0 0 10px rgba(167,139,250,.55))
              drop-shadow(0 0 22px rgba(124,240,195,.35));
    }

    .pixelStars .s{
      position:absolute;
      width:18px; height:18px;
      image-rendering: pixelated;
      opacity:0;
      transform: translate3d(var(--x,0), var(--y,0), 0) scale(var(--sc,1));
      animation:
        twinkleHard var(--tw, 2200ms) steps(7,end) infinite,
        driftSoft  var(--dr, 12000ms) linear infinite,
        popPulse   1400ms steps(6,end) infinite;
      animation-delay: var(--d, 0ms);
    }

    .pixelStars .s::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(rgba(183,166,255,.98), rgba(183,166,255,.98)) 8px 2px/2px 14px no-repeat,
        linear-gradient(rgba(183,166,255,.98), rgba(183,166,255,.98)) 2px 8px/14px 2px no-repeat,
        linear-gradient(rgba(255,255,255,.98), rgba(255,255,255,.98)) 8px 8px/2px 2px no-repeat,
        linear-gradient(rgba(255,255,255,.75), rgba(255,255,255,.75)) 14px 4px/2px 2px no-repeat,
        linear-gradient(rgba(255,255,255,.65), rgba(255,255,255,.65)) 2px 16px/2px 2px no-repeat,
        linear-gradient(rgba(124,240,195,.80), rgba(124,240,195,.80)) 14px 12px/2px 2px no-repeat;
      border-radius:3px;
    }

    .pixelStars .s.diamond::before{
      background:
        linear-gradient(rgba(255,255,255,.96), rgba(255,255,255,.96)) 8px 4px/2px 10px no-repeat,
        linear-gradient(rgba(255,255,255,.96), rgba(255,255,255,.96)) 4px 8px/10px 2px no-repeat,
        linear-gradient(rgba(183,166,255,.92), rgba(183,166,255,.92)) 8px 8px/2px 2px no-repeat,
        linear-gradient(rgba(124,240,195,.70), rgba(124,240,195,.70)) 14px 6px/2px 2px no-repeat,
        linear-gradient(rgba(255,111,169,.55), rgba(255,111,169,.55)) 2px 14px/2px 2px no-repeat;
    }

    @keyframes twinkleHard{
      0%{opacity:0}
      12%{opacity:.45}
      24%{opacity:1}
      40%{opacity:.85}
      60%{opacity:.55}
      100%{opacity:0}
    }
    @keyframes driftSoft{
      0%{ transform: translate3d(var(--x,0), var(--y,0), 0) scale(var(--sc,1)); }
      100%{ transform: translate3d(calc(var(--x,0) - 10px), calc(var(--y,0) + 8px), 0) scale(var(--sc,1)); }
    }
    @keyframes popPulse{
      0%,100%{ transform: translate3d(var(--x,0), var(--y,0), 0) scale(calc(var(--sc,1) * 1)); }
      50%{ transform: translate3d(var(--x,0), var(--y,0), 0) scale(calc(var(--sc,1) * 1.12)); }
    }

    /* floating hearts */
    .hearts{position:fixed; inset:0; pointer-events:none; z-index:3; opacity:.28;}
    .hearts i{
      position:absolute;
      width:10px; height:10px;
      background:
        radial-gradient(circle at 30% 35%, rgba(255,255,255,.70), transparent 35%),
        linear-gradient(180deg, rgba(255,111,169,.95), rgba(255,155,196,.75));
      transform: rotate(45deg);
      border-radius:2px;
      box-shadow: 0 10px 18px rgba(255,111,169,.12);
      animation: floaty linear infinite;
    }
    .hearts i::before,.hearts i::after{
      content:"";
      position:absolute;
      width:10px; height:10px;
      border-radius:50%;
      background: inherit;
      top:-5px; left:0;
    }
    .hearts i::after{left:-5px; top:0;}
    @keyframes floaty{
      0%{ transform: translate3d(0, 110vh, 0) rotate(45deg); opacity:0; }
      10%{opacity:.9}
      100%{ transform: translate3d(0, -20vh, 0) rotate(45deg); opacity:0; }
    }

    /* click burst hearts */
    #burstLayer{ position:fixed; inset:0; pointer-events:none; z-index:50; }
    .burstHeart{
      position:absolute;
      width:10px; height:10px;
      transform: translate(-50%,-50%) rotate(45deg);
      border-radius:2px;
      background:
        radial-gradient(circle at 30% 35%, rgba(255,255,255,.80), transparent 35%),
        linear-gradient(180deg, rgba(255,111,169,.98), rgba(255,155,196,.78));
      box-shadow: 0 10px 18px rgba(255,111,169,.18);
      animation: burstMove var(--dur, 720ms) cubic-bezier(.16,.8,.22,1) forwards;
      opacity:1;
      image-rendering: pixelated;
      will-change: transform, opacity;
    }
    .burstHeart::before,.burstHeart::after{
      content:"";
      position:absolute;
      width:10px; height:10px;
      border-radius:50%;
      background: inherit;
      top:-5px; left:0;
    }
    .burstHeart::after{left:-5px; top:0;}
    @keyframes burstMove{
      0%{ transform: translate(-50%,-50%) rotate(45deg) scale(var(--sc0,1)); opacity:1; }
      100%{ transform: translate(calc(-50% + var(--dx,0px)), calc(-50% + var(--dy,0px))) rotate(45deg) scale(var(--sc1,.6)); opacity:0; }
    }

    .wrap{max-width:980px;margin:0 auto; position:relative; z-index:5;}

    header{
      position:sticky; top:0; z-index:10;
      padding:14px 14px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.40));
      backdrop-filter: blur(12px);
      border-bottom: var(--pixel) solid rgba(167,139,250,.35);
      box-shadow: 0 10px 28px rgba(40,20,50,.10);
    }

    .titleRow{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;}
    h1{
      margin:0;
      font-family:"Press Start 2P", system-ui;
      font-size:14px;
      line-height:1.2;
      letter-spacing:1px;
      color: rgba(76,44,105,.92);
      text-shadow: 0 2px 0 rgba(255,255,255,.75);
      display:flex; gap:10px; align-items:center;
    }
    .heartBadge{
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px;
      border: var(--pixel) solid rgba(255,111,169,.45);
      border-radius:8px;
      background: rgba(255,111,169,.10);
      box-shadow: 0 10px 26px rgba(255,111,169,.12);
      transform: translateY(-1px);
    }
    .heartBadge span{color:#ff6fa9; font-size:16px;}

    .btnRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{
      border: var(--pixel) solid rgba(167,139,250,.55);
      background: linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.48));
      color: rgba(76,44,105,.95);
      border-radius:14px;
      padding:10px 14px;
      font-size:18px;
      cursor:pointer;
      box-shadow: 0 12px 26px rgba(40,20,50,.12);
      backdrop-filter: blur(10px);
    }
    .btn.primary{ border-color: rgba(124,240,195,.70); }
    .btn.danger{ border-color: rgba(255,111,169,.55); }

    main{padding:16px 14px 44px; position:relative; z-index:5;}

    .card{
      background: var(--panel);
      border: var(--pixel) solid rgba(167,139,250,.38);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 22px 60px rgba(40,20,50,.18);
      position:relative;
      backdrop-filter: blur(12px);
    }

    .head{
      position:relative; z-index:1;
      padding:12px 12px;
      border-bottom: var(--pixel) solid rgba(167,139,250,.28);
      color: rgba(76,44,105,.85);
      font-size:18px;
      display:grid;
      grid-template-columns: 120px 1fr 190px;
      gap:12px;
      align-items:center;
      text-transform:lowercase;
      background: linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,0));
    }
    .head div:last-child{text-align:right}

    /* ‚úÖ Reserve space on desktop so the marker can float on the right */
    .list{
      display:flex;
      flex-direction:column;
      position:relative;
      z-index:1;
      padding-right:190px;
    }

    .row{
      display:grid;
      grid-template-columns: 120px 1fr 190px;
      gap:12px;
      padding:12px 12px;
      align-items:center;
      border-bottom: 1px solid rgba(167,139,250,.22);
      position:relative;
      z-index:0;
    }

    .row::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:0;
      background:
        radial-gradient(400px 220px at 18% 35%, rgba(167,139,250,.10), transparent 60%),
        radial-gradient(420px 240px at 78% 55%, rgba(124,240,195,.10), transparent 62%);
      z-index:0;
      pointer-events:none;
    }

    .row > *{ position:relative; z-index:1; }

    .dayBtn{
      width:100%;
      border: var(--pixel) solid rgba(167,139,250,.55);
      outline:none;
      background: rgba(255,255,255,.62);
      color: rgba(76,44,105,.90);
      font-family:"Press Start 2P", system-ui;
      font-size:11px;
      padding:12px 10px;
      border-radius:14px;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.65),
        0 10px 22px rgba(40,20,50,.10);
      cursor:pointer;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .task{
      width:100%;
      border: var(--pixel) solid rgba(167,139,250,.45);
      outline:none;
      background: rgba(255,255,255,.70);
      color: var(--fg);
      font-family:"VT323", monospace;
      font-size:22px;
      padding:16px 14px;
      border-radius:16px;
      min-width:0;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.70),
        0 10px 24px rgba(40,20,50,.10);
      line-height:1.15;
      min-height:92px;
      resize:none;
      overflow-wrap: break-word;
    }

    textarea, input, button{-webkit-appearance:none;appearance:none;touch-action: manipulation;}

    .done .task, .done .dayBtn{
      opacity:.62;
      text-decoration: line-through;
      text-decoration-thickness: 3px;
      text-decoration-color: rgba(255,111,169,.55);
      filter:saturate(.92);
    }

    .usCell{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      position:relative;
      z-index:9;
      isolation:isolate;
    }

    /* ‚úÖ Marker floats over the list and moves smoothly */
    .marker{
      position:absolute;
      right:12px;
      top:0;
      transform-origin: 50% 100%;
      filter: drop-shadow(0 12px 18px rgba(40,20,50,.22));
      z-index:20;
      transition: top 700ms cubic-bezier(.22,.8,.3,1);
      pointer-events:none;
    }
    .marker.idle{ animation: idleBob 1.6s ease-in-out infinite; }
    @keyframes idleBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}

    canvas.couple{
      width:176px;
      height:122px;
      image-rendering: pixelated;
      background: transparent;
      border:none;
      display:block;
      position:relative;
      z-index:11;
    }

    .footer{
      position:relative; z-index:1;
      padding:12px 12px;
      border-top: var(--pixel) solid rgba(167,139,250,.22);
      display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between;
      color: rgba(76,44,105,.70);
      font-size:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,0));
    }
    .footer b{color:rgba(255,111,169,.88)}
    .footer span{color:rgba(60,180,140,.95)}

    @media (max-width:560px){
      .head{grid-template-columns: 86px 1fr; grid-template-areas:"day task" "us us"; gap:10px;}
      .head .h-day{grid-area:day}
      .head .h-task{grid-area:task}
      .head .h-us{grid-area:us;text-align:right;opacity:.65;padding-top:2px;}

      /* ‚úÖ On mobile we DON'T reserve right padding */
      .list{ padding-right:0; }

      .row{
        grid-template-columns: 86px 1fr;
        grid-template-areas:"day task" "us us";
        gap:10px;
        align-items:start;
      }
      .dayBtn{ grid-area:day; font-size:10px; padding:10px 10px; }
      .task{ grid-area:task; font-size:21px; min-height:96px; }

      /* ‚úÖ base usCell: NO fixed min-height (prevents big empty gaps on every row) */
      .usCell{
        grid-area:us;
        justify-content:flex-end;
        padding-top:8px;
        min-height:0;
      }

      /* ‚úÖ ONLY the active row reserves space for the marker */
      .row.hasMarker .usCell{
        min-height:100px; /* matches the couple canvas height (100px) */
      }

      /* ‚úÖ remove extra padding-bottom spacer (it was doubling the gap) */
      .row.hasMarker{ padding-bottom: 0; }

      canvas.couple{ width:140px; height:100px; }

      /* marker stays absolute (walking animation stays) */
      .marker{ right:12px; }
    }

    @media (max-width:380px){
      .head, .row{ grid-template-columns: 80px 1fr; }
      canvas.couple{ width:126px; height:90px; }
      .task{ font-size:20px; }

      /* ‚úÖ keep active-row spacing matched to the smaller canvas */
      .row.hasMarker .usCell{ min-height:90px; }
    }
  </style>
</head>

<body>
  <div class="pixelStars" id="pixelStars" aria-hidden="true"></div>

  <div class="hearts" aria-hidden="true">
    <i style="left:8%;  animation-duration:9.5s; animation-delay:-2s;  opacity:.35; transform:scale(1.2) rotate(45deg)"></i>
    <i style="left:18%; animation-duration:12s;  animation-delay:-7s;  opacity:.25; transform:scale(.9) rotate(45deg)"></i>
    <i style="left:33%; animation-duration:10.5s; animation-delay:-5s;  opacity:.32; transform:scale(1.0) rotate(45deg)"></i>
    <i style="left:48%; animation-duration:13s;  animation-delay:-9s;  opacity:.22; transform:scale(.8) rotate(45deg)"></i>
    <i style="left:62%; animation-duration:11s;  animation-delay:-4s;  opacity:.30; transform:scale(1.1) rotate(45deg)"></i>
    <i style="left:76%; animation-duration:9.8s; animation-delay:-6s;  opacity:.26; transform:scale(.95) rotate(45deg)"></i>
    <i style="left:90%; animation-duration:12.6s; animation-delay:-3s;  opacity:.28; transform:scale(1.05) rotate(45deg)"></i>
  </div>

  <div id="burstLayer" aria-hidden="true"></div>

  <header>
    <div class="wrap">
      <div class="titleRow">
        <div>
          <h1>
            <span class="heartBadge"><span>‚ô•</span></span>
            Bunny Missions‚ùÄ‚ô•
            <span style="color:var(--neon)">üíö</span>
          </h1>
        </div>
        <div class="btnRow">
          <button class="btn primary" id="addRow">+ Row</button>
          <button class="btn danger" id="reset">Reset</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="card">
        <div class="head">
          <div class="h-day">when</div>
          <div class="h-task">where</div>
          <div class="h-us">hearts in motion</div>
        </div>

        <div class="list" id="list"></div>

        <div class="footer">
          <div>Auto-saves on this device. <b>‚ô•</b></div>
          <div><span>Tip:</span> wild hearted bunnies.
no rest, only the road.
dream bound. night hopping.
the bunny revolution is coming, one day at a time.‚ùÄüêá</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const KEY = "valentine_todo_advance_v1";
    const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

    const DEFAULT = {
      rows: [
        { day: "Mon", task: "Something sweet #1", done: false },
        { day: "Tue", task: "Something sweet #2", done: false },
        { day: "Wed", task: "Something sweet #3", done: false },
        { day: "Thu", task: "Something sweet #4", done: false },
        { day: "Fri", task: "Something sweet #5", done: false },
      ],
      markerRow: 0
    };

    const YOU = {
      outline:"#0a0d10",
      skin:"#e7c4a7",
      skinShade:"#d6ab8b",
      blush:"#ff8fb0",
      hair:"#050607",
      hair2:"#f3d58b",
      eye:"#0b2b1a",
      eye2:"#071a10",
      tee:"#050607",
      tee2:"#0d0f12",
      teeShade:"#020304",
      pants:"#0c1117",
      pants2:"#121a24",
      shoe:"#0a0d10",
      shoe2:"#121821",
      accent:"#39ff88"
    };

    const BUNNY = {
      outline:"#0a0d10",
      skin:"#e7c4a7",
      skinShade:"#d6ab8b",
      blush:"#ff8fb0",
      hair:"#7b3dff",
      hair2:"#4a26b8",
      eye:"#24160c",
      eye2:"#0f0703",
      tee:"#0f0f14",
      tee2:"#1b1b26",
      teeShade:"#0a0a10",
      denim:"#2b5bff",
      denim2:"#1f3fb6",
      denimShade:"#162a7a",
      shoe:"#0a0d10",
      shoe2:"#171726",
      glasses:"#d7e8ff"
    };

    let state = load();

    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return structuredClone(DEFAULT);
        const data = JSON.parse(raw);
        if(!data || !Array.isArray(data.rows)) return structuredClone(DEFAULT);
        return data;
      }catch(e){ return structuredClone(DEFAULT); }
    }
    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

    const list = document.getElementById("list");

    /* stars */
    const starLayer = document.getElementById("pixelStars");
    function makeStars(count=90){
      if(!starLayer) return;
      starLayer.innerHTML = "";
      const vw = Math.max(320, window.innerWidth);
      const vh = Math.max(560, window.innerHeight);
      for(let i=0;i<count;i++){
        const s = document.createElement("div");
        s.className = "s";
        if(Math.random() < 0.25) s.classList.add("diamond");
        const x = Math.floor(Math.random()*vw);
        const y = Math.floor(Math.random()*vh);
        const sc = (Math.random()*1.2 + 0.85).toFixed(2);
        const tw = Math.floor(1200 + Math.random()*2000);
        const dr = Math.floor(9000 + Math.random()*14000);
        const d  = Math.floor(Math.random()*2600);
        s.style.setProperty("--x", x+"px");
        s.style.setProperty("--y", y+"px");
        s.style.setProperty("--sc", sc);
        s.style.setProperty("--tw", tw+"ms");
        s.style.setProperty("--dr", dr+"ms");
        s.style.setProperty("--d",  (-d)+"ms");
        starLayer.appendChild(s);
      }
    }
    makeStars(40);
    window.addEventListener("resize", ()=>makeStars(40));

    /* click heart burst */
    const burstLayer = document.getElementById("burstLayer");
    function heartBurst(x, y){
      if(!burstLayer) return;
      const n = 14;
      for(let i=0;i<n;i++){
        const h = document.createElement("div");
        h.className = "burstHeart";
        h.style.left = x+"px";
        h.style.top  = y+"px";

        const angle = Math.random() * Math.PI * 2;
        const dist  = 18 + Math.random()*52;
        const dx = Math.cos(angle) * dist;
        const dy = Math.sin(angle) * dist - (10 + Math.random()*18);

        const dur = 520 + Math.random()*420;
        const sc0 = (0.85 + Math.random()*0.5).toFixed(2);
        const sc1 = (0.45 + Math.random()*0.35).toFixed(2);

        h.style.setProperty("--dx", dx.toFixed(1)+"px");
        h.style.setProperty("--dy", dy.toFixed(1)+"px");
        h.style.setProperty("--dur", dur.toFixed(0)+"ms");
        h.style.setProperty("--sc0", sc0);
        h.style.setProperty("--sc1", sc1);

        burstLayer.appendChild(h);
        setTimeout(()=> h.remove(), dur + 60);
      }
    }
    document.addEventListener("pointerdown", (e)=>{
      if(e.button !== undefined && e.button !== 0) return;
      const x = e.clientX ?? (e.touches && e.touches[0] ? e.touches[0].clientX : innerWidth/2);
      const y = e.clientY ?? (e.touches && e.touches[0] ? e.touches[0].clientY : innerHeight/2);
      heartBurst(x, y);
    }, { passive:true });

    /* sprites */
    function setupCanvas(canvas, W, H){
      canvas.width = W; canvas.height = H;
      const ctx = canvas.getContext("2d", { alpha: true });
      ctx.imageSmoothingEnabled = false;
      ctx.clearRect(0,0,W,H);
      return ctx;
    }
    function px(ctx, x, y, c){ ctx.fillStyle = c; ctx.fillRect(x,y,1,1); }
    function rect(ctx, x, y, w, h, c){ ctx.fillStyle = c; ctx.fillRect(x,y,w,h); }
    function outlineRect(ctx, x, y, w, h, c){
      for(let i=0;i<w;i++){ px(ctx, x+i, y, c); px(ctx, x+i, y+h-1, c); }
      for(let j=0;j<h;j++){ px(ctx, x, y+j, c); px(ctx, x+w-1, y+j, c); }
    }
    function cut4(ctx, x, y, w, h){
      ctx.clearRect(x, y, 1, 1);
      ctx.clearRect(x+w-1, y, 1, 1);
      ctx.clearRect(x, y+h-1, 1, 1);
      ctx.clearRect(x+w-1, y+h-1, 1, 1);
    }
    function drawShadow(ctx, cx, y){
      rect(ctx, cx-8, y,   16, 2, "rgba(0,0,0,.26)");
      rect(ctx, cx-6, y+2, 12, 2, "rgba(0,0,0,.18)");
      rect(ctx, cx-3, y+4,  6, 1, "rgba(0,0,0,.10)");
    }

    function drawPerson(ctx, ox, oy, p, frame){
      const f = frame % 4;
      const step = (f === 1) ? -1 : (f === 3 ? 1 : 0);
      const bob  = (f === 1 || f === 3) ? 0 : 1;

      const cx = ox + 28;
      const top = oy + 2 + bob;

      const hw=22, hh=18;
      const hx = cx - Math.floor(hw/2);
      const hy = top + 2;

      rect(ctx, hx, hy, hw, hh, p.skin);
      rect(ctx, hx+2, hy+hh-2, hw-4, 1, p.skinShade);
      rect(ctx, hx+3, hy+hh-1, hw-6, 1, p.skinShade);
      cut4(ctx, hx, hy, hw, hh);
      cut4(ctx, hx+1, hy+1, hw-2, hh-2);
      rect(ctx, cx-2, hy+hh, 4, 2, p.skinShade);

      if(p === YOU){
        rect(ctx, hx+3, hy-7, hw-6, 2, p.hair);
        rect(ctx, hx+1, hy-5, hw-2, 3, p.hair);
        rect(ctx, hx-1, hy-2, hw+2, 5, p.hair);
        rect(ctx, hx-2,    hy+3, 3, 9, p.hair);
        rect(ctx, hx+hw-1, hy+3, 3, 9, p.hair);
        px(ctx, hx+2, hy-6, p.hair);
        px(ctx, hx+hw-3, hy-6, p.hair);
      } else {
        rect(ctx, hx-2, hy-5, hw+4, 8, p.hair);
        rect(ctx, hx-4, hy+3, 6, 10, p.hair);
        rect(ctx, hx+hw-2, hy+3, 6, 10, p.hair);
      }

      rect(ctx, hx+3, hy+2, hw-6, 3, p.hair2);
      rect(ctx, hx+4, hy+5, hw-8, 2, p.hair2);

      if(p === YOU){
        rect(ctx, hx+2,  hy+6, 2, 3, p.hair2);
        rect(ctx, hx+6,  hy+6, 3, 1, p.hair2);
        rect(ctx, hx+10, hy+6, 3, 1, p.hair2);
        px(ctx, hx+7,  hy+7, p.hair2);
        px(ctx, hx+11, hy+7, p.hair2);
      }

      if(p === BUNNY){
        rect(ctx, hx-6, hy+10, 6, 14, p.hair);
        rect(ctx, hx+hw, hy+10, 6, 14, p.hair);
        rect(ctx, hx-5, hy+14, 4, 10, p.hair2);
        rect(ctx, hx+hw+1, hy+14, 4, 10, p.hair2);
      }

      const ey = hy + 8;
      rect(ctx, cx-10, ey, 7, 1, p.outline);
      rect(ctx, cx+3,  ey, 7, 1, p.outline);

      rect(ctx, cx-10, ey+1, 7, 7, p.eye);
      rect(ctx, cx+3,  ey+1, 7, 7, p.eye);

      rect(ctx, cx-10, ey+7, 7, 1, p.eye2);
      rect(ctx, cx+3,  ey+7, 7, 1, p.eye2);

      px(ctx, cx-9, ey+2, "rgba(255,255,255,.95)");
      px(ctx, cx-8, ey+3, "rgba(255,255,255,.80)");
      px(ctx, cx+4, ey+2, "rgba(255,255,255,.95)");
      px(ctx, cx+5, ey+3, "rgba(255,255,255,.80)");

      rect(ctx, cx-13, hy+14, 4, 2, "rgba(255,143,176,.55)");
      rect(ctx, cx+9,  hy+14, 4, 2, "rgba(255,143,176,.55)");

      rect(ctx, cx-1, hy+15, 2, 1, "rgba(20,10,12,.55)");
      rect(ctx, cx-1, hy+16, 2, 1, "rgba(255,155,196,.55)");

      if (p === BUNNY && p.glasses) {
        const gy = ey+1;
        const lensFill = "rgba(215,232,255,.22)";
        rect(ctx, cx-10, gy, 8, 7, lensFill);
        outlineRect(ctx, cx-11, gy-1, 10, 9, p.glasses);
        rect(ctx, cx+2, gy, 8, 7, lensFill);
        outlineRect(ctx, cx+1, gy-1, 10, 9, p.glasses);
        rect(ctx, cx-1, gy+3, 2, 2, p.glasses);
        rect(ctx, cx-14, gy+2, 2, 1, p.glasses);
        rect(ctx, cx+12, gy+2, 2, 1, p.glasses);
      }

      const bodyY = hy + hh + 2;

      if(p === YOU){
        rect(ctx, cx-10, bodyY, 20, 12, p.tee);
        rect(ctx, cx-10, bodyY, 20, 4,  p.tee2);
        rect(ctx, cx-9, bodyY+10, 18, 2, p.teeShade);
        rect(ctx, cx-7, bodyY-4, 14, 6, p.tee2);
        rect(ctx, cx-5, bodyY-2, 10, 3, p.teeShade);

        rect(ctx, cx-2, bodyY+3, 1, 5, "rgba(233,255,244,.65)");
        rect(ctx, cx+1, bodyY+3, 1, 5, "rgba(233,255,244,.65)");
        px(ctx, cx-2, bodyY+8, p.outline);
        px(ctx, cx+1, bodyY+8, p.outline);

        rect(ctx, cx-1, bodyY+6, 2, 2, p.accent);

        outlineRect(ctx, cx-10, bodyY, 20, 12, p.outline);
        outlineRect(ctx, cx-7, bodyY-4, 14, 6, p.outline);
      } else {
        rect(ctx, cx-8, bodyY, 16, 10, p.tee);
        rect(ctx, cx-8, bodyY, 16, 3,  p.tee2);
        rect(ctx, cx-7, bodyY+8, 14, 1, p.teeShade);

        outlineRect(ctx, cx-8, bodyY, 16, 10, p.outline);
      }

      if(p === BUNNY){
        const gx = cx-3, gy = bodyY+4;
        outlineRect(ctx, gx-3, gy-1, 7, 7, "rgba(255,155,196,.70)");
        rect(ctx, gx-2, gy, 5, 5, "rgba(0,0,0,.35)");
        px(ctx, gx-1, gy+2, "rgba(233,255,244,.80)");
        px(ctx, gx+1, gy+2, "rgba(233,255,244,.80)");
        rect(ctx, gx-1, gy+3, 3, 1, "rgba(233,255,244,.65)");
      }

      const armY = bodyY + 3;

      if(p === YOU){
        rect(ctx, cx-13, armY, 5, 7, p.tee2);
        rect(ctx, cx-12, armY+5, 3, 3, p.skin);
        outlineRect(ctx, cx-13, armY, 5, 7, p.outline);

        rect(ctx, cx+8, armY, 5, 7, p.tee2);
        rect(ctx, cx+9, armY+5, 3, 3, p.skinShade);
        outlineRect(ctx, cx+8, armY, 5, 7, p.outline);
      } else {
        rect(ctx, cx-11, armY + (step===-1?1:0), 3, 5, p.tee2);
        rect(ctx, cx-11, armY+5 + (step===-1?1:0), 3, 2, p.skin);
        rect(ctx, cx+8,  armY + (step=== 1?1:0), 3, 5, p.tee2);
        rect(ctx, cx+8,  armY+5 + (step=== 1?0:0), 3, 2, p.skinShade);
      }

      const legY = bodyY + (p === YOU ? 12 : 10);

      if(p === BUNNY){
        rect(ctx, cx-8, legY,   16, 2, p.denim2);
        rect(ctx, cx-8, legY+2, 16, 4, p.denim);
        rect(ctx, cx-8, legY+5, 16, 1, p.denimShade);
        rect(ctx, cx-1, legY+2, 2, 4, p.denim2);

        rect(ctx, cx-7, legY+6, 6, 6, p.skin);
        rect(ctx, cx+1, legY+6, 6, 6, p.skinShade);

        rect(ctx, cx-8, legY+12, 7, 2, p.shoe);
        rect(ctx, cx+1, legY+12, 7, 2, p.shoe2);

        outlineRect(ctx, cx-8, legY, 16, 14, p.outline);
      } else {
        rect(ctx, cx-8, legY, 16, 2, p.pants2);
        rect(ctx, cx-7, legY+2, 6, 8, p.pants);
        rect(ctx, cx+1, legY+2, 6, 8, p.pants);

        rect(ctx, cx-8, legY+10, 7, 2, p.shoe);
        rect(ctx, cx+1, legY+10, 7, 2, p.shoe2);

        outlineRect(ctx, cx-8, legY, 16, 12, p.outline);
      }

      outlineRect(ctx, hx, hy, hw, hh, p.outline);

      if(p === YOU){
        const horn = "#c1121f";
        const o = p.outline;

        px(ctx, hx+6, hy-7, o);
        px(ctx, hx+5, hy-6, o); px(ctx, hx+7, hy-6, o);
        px(ctx, hx+4, hy-5, o); px(ctx, hx+8, hy-5, o);
        px(ctx, hx+4, hy-4, o); px(ctx, hx+8, hy-4, o);
        rect(ctx, hx+4, hy-3, 5, 1, o);

        px(ctx, hx+6, hy-6, horn);
        rect(ctx, hx+5, hy-5, 3, 1, horn);
        rect(ctx, hx+5, hy-4, 3, 1, horn);
        rect(ctx, hx+5, hy-3, 3, 1, horn);

        px(ctx, hx+hw-7, hy-7, o);
        px(ctx, hx+hw-8, hy-6, o); px(ctx, hx+hw-6, hy-6, o);
        px(ctx, hx+hw-9, hy-5, o); px(ctx, hx+hw-5, hy-5, o);
        px(ctx, hx+hw-9, hy-4, o); px(ctx, hx+hw-5, hy-4, o);
        rect(ctx, hx+hw-9, hy-3, 5, 1, o);

        px(ctx, hx+hw-7, hy-6, horn);
        rect(ctx, hx+hw-8, hy-5, 3, 1, horn);
        rect(ctx, hx+hw-8, hy-4, 3, 1, horn);
        rect(ctx, hx+hw-8, hy-3, 3, 1, horn);
      }

      if(p === BUNNY){
        const earOuter = "#ffffff";
        const earInner = "#ff9ed6";
        const o = p.outline;
        const earTop = hy - 9;

        px(ctx, hx+4, earTop, o);
        px(ctx, hx+3, earTop+1, o); px(ctx, hx+5, earTop+1, o);
        px(ctx, hx+2, earTop+2, o); px(ctx, hx+6, earTop+2, o);
        rect(ctx, hx+2, earTop+3, 6, 1, o);

        px(ctx, hx+4, earTop+1, earOuter);
        rect(ctx, hx+3, earTop+2, 3, 1, earOuter);
        rect(ctx, hx+3, earTop+3, 4, 1, earOuter);

        px(ctx, hx+4, earTop+2, earInner);
        rect(ctx, hx+4, earTop+3, 2, 1, earInner);

        px(ctx, hx+hw-5, earTop, o);
        px(ctx, hx+hw-6, earTop+1, o); px(ctx, hx+hw-4, earTop+1, o);
        px(ctx, hx+hw-7, earTop+2, o); px(ctx, hx+hw-3, earTop+2, o);
        rect(ctx, hx+hw-8, earTop+3, 6, 1, o);

        px(ctx, hx+hw-5, earTop+1, earOuter);
        rect(ctx, hx+hw-6, earTop+2, 3, 1, earOuter);
        rect(ctx, hx+hw-7, earTop+3, 4, 1, earOuter);

        px(ctx, hx+hw-5, earTop+2, earInner);
        rect(ctx, hx+hw-6, earTop+3, 2, 1, earInner);
      }
    }

    function drawCouple(canvas, frame=0){
      const SHIFT = 10;
      const OFFSET_Y = 10;
      const ctx = setupCanvas(canvas, 112 - SHIFT, 92);

      const leftCenter = 28;
      const rightCenter = 84 - SHIFT;

      drawShadow(ctx, leftCenter, 82);
      drawShadow(ctx, rightCenter, 82);

      drawPerson(ctx, 0, OFFSET_Y, YOU, frame);
      drawPerson(ctx, 56 - SHIFT, OFFSET_Y, BUNNY, frame);
    }

    function makeMarker(){
      const m = document.createElement("div");
      m.className = "marker idle";
      const c = document.createElement("canvas");
      c.className = "couple";
      m.appendChild(c);
      m._canvas = c;
      drawCouple(c, 0);
      return m;
    }

    function animateWalk(marker, duration = 720){
      if(!marker || !marker._canvas) return;
      marker.classList.remove("idle");
      const start = performance.now();
      function step(now){
        const t = now - start;
        const frame = Math.floor(t / 90) % 8;
        drawCouple(marker._canvas, frame);
        if(t < duration) requestAnimationFrame(step);
        else { drawCouple(marker._canvas, 0); marker.classList.add("idle"); }
      }
      requestAnimationFrame(step);
    }

    function normalize(){
      state.markerRow = Math.max(0, Math.min(state.rows.length-1, state.markerRow||0));
      for(const r of state.rows){
        if(typeof r.day !== "string") r.day = "";
        if(typeof r.task !== "string") r.task = "";
        r.done = !!r.done;
      }
    }

    function setProgress(targetIndex){
      const cur = state.markerRow || 0;
      targetIndex = Math.max(0, Math.min(state.rows.length-1, targetIndex));
      state.rows.forEach((row, i) => { row.done = i < targetIndex; });
      state.markerRow = targetIndex;

      const didAdvance = targetIndex > cur;
      save();
      render({ animate: didAdvance });
    }

    let globalMarker = null;

    function isMobileLayout(){
      return window.matchMedia("(max-width: 560px)").matches;
    }

    function render(opts = {}){
      normalize();
      list.innerHTML = "";

      state.rows.forEach((r, ri)=>{
        const row = document.createElement("div");
        row.className = "row" + (r.done ? " done" : "");
        row.dataset.index = String(ri);

        if(ri === state.markerRow){
          row.classList.add("hasMarker");
        }

        const dayBtn = document.createElement("button");
        dayBtn.className = "dayBtn";
        dayBtn.type = "button";
        dayBtn.textContent = r.day || "Day";
        dayBtn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const val = prompt("Rename day / time:", r.day);
          if(val !== null){
            r.day = val.trim() || r.day;
            save();
            render();
          }
          setProgress(ri);
        });

        const task = document.createElement("textarea");
        task.className = "task";
        task.rows = 2;
        task.value = r.task || "";
        task.placeholder = "type something sweet‚Ä¶";
        task.addEventListener("input", ()=>{
          r.task = task.value;
          save();
        });

        // ‚úÖ IMPORTANT: don't let the row click re-render while you're trying to focus/type
        // (mobile keyboard won't pop if we immediately rebuild the DOM)
        task.addEventListener("pointerdown", (e)=> e.stopPropagation());
        task.addEventListener("click", (e)=> e.stopPropagation());
        task.addEventListener("focus", (e)=> e.stopPropagation());

        const right = document.createElement("div");
        right.className = "usCell";
        right.appendChild(document.createElement("div"));

        row.addEventListener("click", (e)=>{
          // clicking inside the textarea should ONLY focus/type (no rerender)
          if(e.target === dayBtn) return;
          if(e.target === task || e.target.closest("textarea")) return;
          setProgress(ri);
        });

        row.append(dayBtn, task, right);
        list.appendChild(row);
      });

      if(!globalMarker){
        globalMarker = makeMarker();
      }
      list.appendChild(globalMarker);

      const rows = document.querySelectorAll(".row");
      const targetRow = rows[state.markerRow];
      if(!targetRow || !globalMarker) return;

      const listRect = list.getBoundingClientRect();

      let targetRect = targetRow.getBoundingClientRect();
      if(isMobileLayout()){
        const us = targetRow.querySelector(".usCell");
        if(us) targetRect = us.getBoundingClientRect();
      }

      const offset = targetRect.top - listRect.top;
      globalMarker.style.top = offset + "px";

      if(opts.animate){
        animateWalk(globalMarker, 750);
      }
    }

    function addRow(){
      const idx = state.rows.length;
      const day = DAYS[idx % DAYS.length] || `Day ${idx+1}`;
      state.rows.push({ day, task:"", done:false });
      normalize();
      save();
      render();
    }

    document.getElementById("addRow").addEventListener("click", addRow);
    document.getElementById("reset").addEventListener("click", ()=>{
      if(!confirm("Reset everything?")) return;
      state = structuredClone(DEFAULT);
      save();
      render();
    });

    // ‚úÖ Mobile keyboard fix:
    // On mobile, opening the keyboard triggers a window "resize".
    // If we call render() during that, the textarea gets rebuilt and loses focus ‚Üí keyboard closes.
    let __renderResizeT = null;
    function __safeRenderOnResize(){
      const ae = document.activeElement;
      if(ae && ae.classList && ae.classList.contains("task")) return; // don't re-render while typing
      clearTimeout(__renderResizeT);
      __renderResizeT = setTimeout(()=>render(), 180);
    }
    window.addEventListener("resize", __safeRenderOnResize);
    // Some mobile browsers fire resize on visualViewport instead of window
    if(window.visualViewport){
      window.visualViewport.addEventListener("resize", __safeRenderOnResize);
    }

normalize();
    save();
    render();
  </script>
</body>
</html>